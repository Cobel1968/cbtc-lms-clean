'use client';
import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';

export default function StudentDashboard() {
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        async function loadProfile() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { setLoading(false); return; }

            const { data: progress } = await supabase
                .from('user_progress')
                .select('*')
                .eq('user_id', user.id)
                .order('updated_at', { ascending: false })
                .limit(1);

            if (progress && progress[0]) {
                const latest = progress[0];
                const baseDays = 90;
                const savings = latest.last_score >= 15 ? 15 : 0;
                const compDate = new Date();
                compDate.setDate(compDate.getDate() + (baseDays - savings));

                setData({
                    ...latest,
                    savings,
                    projectedDate: compDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }),
                    progressPercent: Math.round(((baseDays - (baseDays - savings)) / baseDays) * 100)
                });
            }
            setLoading(false);
        }
        loadProfile();
    }, []);

    if (loading) {
        return <div style={{ padding: '50px', textAlign: 'center' }}>Chargement du moteur Cobel AI...</div>;
    }

    return (
        <div style={{ minHeight: '100vh', background: '#f8fafc', padding: '20px', fontFamily: 'sans-serif' }}>
            <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', maxWidth: '1100px', margin: '0 auto 40px auto' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                    <img 
                        src="/logo.png" 
                        alt="Cobel BTC" 
                        style={{ height: '60px', width: 'auto', display: 'block' }} 
                        onError={(e) => { e.currentTarget.src = 'https://via.placeholder.com/200x60?text=COBEL+BTC'; }}
                    />
                </div>
                <div style={{ textAlign: 'right' }}>
                    <h2 style={{ margin: 0, color: '#1e40af', fontSize: '20px' }}>Tableau de Bord Étudiant</h2>
                    <p style={{ margin: 0, fontSize: '13px', color: '#64748b' }}>Innovation: Logiciel de Pédagogie Adaptative</p>
                </div>
            </header>

            <main style={{ maxWidth: '1100px', margin: '0 auto', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '25px' }}>
                <section style={{ display: 'flex', flexDirection: 'column', gap: '25px' }}>
                    <div style={{ background: '#fff', padding: '25px', borderRadius: '16px', border: '1px solid #e2e8f0', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                        <h3 style={{ marginTop: 0, color: '#1e40af' }}>F4: Pont d'Analyse (Handwriting)</h3>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '36px', fontWeight: 'bold', color: '#0f172a' }}>{data?.last_score || '0'}/20</span>
                            <span style={{ color: '#16a34a', fontSize: '14px', background: '#dcfce7', padding: '4px 10px', borderRadius: '20px' }}>Précision: {data?.ocr_accuracy || '0'}%</span>
                        </div>
                        <div style={{ marginTop: '20px' }}>
                            <p style={{ fontSize: '12px', fontWeight: 'bold', color: '#64748b', textTransform: 'uppercase' }}>Termes Bilingues Extraits:</p>
                            <div style={{ display: 'flex', gap: '8px', marginTop: '10px', flexWrap: 'wrap' }}>
                                {data?.technical_terms_mastered?.map(t => (
                                    <span key={t} style={{ background: '#eff6ff', border: '1px solid #bfdbfe', color: '#1e40af', padding: '4px 12px', borderRadius: '6px', fontSize: '12px' }}>{t}</span>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div style={{ background: '#fff', padding: '25px', borderRadius: '16px', border: '1px solid #e2e8f0' }}>
                        <h3 style={{ marginTop: 0, color: '#1e40af' }}>F2: Parcours Adaptatif</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                            <div style={{ padding: '12px', background: '#dcfce7', borderRadius: '8px', border: '1px solid #bbf7d0', display: 'flex', justifyContent: 'space-between' }}>
                                <span>Advanced Technical Management</span>
                                <strong style={{ fontSize: '10px', color: '#166534' }}>DÉBLOQUÉ</strong>
                            </div>
                            <div style={{ padding: '12px', background: '#f1f5f9', borderRadius: '8px', border: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', color: '#94a3b8' }}>
                                <span>Basics of Workshop Safety</span>
                                <strong style={{ fontSize: '10px' }}>PASSÉ (OPTIMISÉ)</strong>
                            </div>
                        </div>
                    </div>
                </section>

                <section style={{ background: '#0f172a', color: 'white', padding: '40px', borderRadius: '24px', boxShadow: '0 20px 25px -5px rgba(0,0,0,0.2)' }}>
                    <h3 style={{ marginTop: 0, color: '#3b82f6' }}>F3: Prévision des Jalons</h3>
                    <p style={{ opacity: 0.7, fontSize: '14px' }}>Calcul de l'accélération pédagogique</p>
                    
                    <div style={{ margin: '50px 0' }}>
                        <div style={{ fontSize: '14px', opacity: 0.6, marginBottom: '5px' }}>Date de Fin Projetée</div>
                        <div style={{ fontSize: '42px', fontWeight: 'bold', color: '#fff' }}>{data?.projectedDate || 'Calcul en cours...'}</div>
                    </div>

                    <div style={{ background: '#1e293b', padding: '25px', borderRadius: '15px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '15px' }}>
                            <span>Optimisation Temporelle</span>
                            <span style={{ color: '#10b981', fontWeight: 'bold' }}>-{data?.savings || '0'} Jours</span>
                        </div>
                        <div style={{ width: '100%', height: '10px', background: '#334155', borderRadius: '10px' }}>
                            <div style={{ width: `${data?.progressPercent || 0}%`, height: '100%', background: '#10b981', borderRadius: '10px', transition: 'width 1s ease-in-out' }}></div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    );
}