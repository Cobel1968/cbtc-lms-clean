'use client';
import React, { useState } from 'react';

export default function AssessmentUploader({ userId }: { userId: string }) {
    const [imgBase64, setImgBase64] = useState<string | null>(null);
    const [isProcessing, setIsProcessing] = useState(false);
    const [assessmentNote, setAssessmentNote] = useState<any>(null);

    const handleInversion = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        setIsProcessing(true);
        setAssessmentNote(null);

        const reader = new FileReader();
        reader.onload = (event) => {
            // Force set the base64 string to state
            setImgBase64(event.target?.result as string);
            
            // Simulate the Technical Problem solving (Knowledge Gap Analysis)
            setTimeout(() => {
                setAssessmentNote({
                    grade: "18/20",
                    justification: "Technical terms identified: 'Atelier', 'Equipement'. Excellent bilingual Technical Fluency.",
                    date: new Date().toLocaleDateString()
                });
                setIsProcessing(false);
            }, 1500);
        };
        reader.readAsDataURL(file);
    };

    return (
        <div style={{ 
            border: '3px solid #2563eb', 
            padding: '20px', 
            borderRadius: '15px', 
            background: '#ffffff',
            position: 'relative',
            zIndex: 999 
        }}>
            <h2 style={{ fontSize: '18px', color: '#1e293b', marginBottom: '5px' }}> Analog-to-Digital Bridge</h2>
            <p style={{ fontSize: '11px', color: '#64748b', marginBottom: '15px' }}>
                Essential: Your scan provides proof for your attributed note.
            </p>

            <input 
                type="file" 
                onChange={handleInversion} 
                accept="image/*" 
                style={{ display: 'block', width: '100%', marginBottom: '20px' }}
            />

            {/* CRITICAL: FORCED VISIBILITY PREVIEW */}
            {imgBase64 && (
                <div style={{ 
                    display: 'block', 
                    width: '100%', 
                    border: '4px solid #f97316', 
                    borderRadius: '8px',
                    overflow: 'visible',
                    background: '#000',
                    marginTop: '10px'
                }}>
                    <img 
                        src={imgBase64} 
                        alt="Evidence of Work" 
                        style={{ 
                            display: 'block', 
                            width: '100%', 
                            height: 'auto', 
                            maxHeight: '400px',
                            objectFit: 'contain' 
                        }} 
                    />
                    <div style={{ background: '#f97316', color: '#fff', fontSize: '10px', padding: '5px', textAlign: 'center' }}>
                        SCAN EVIDENCE CAPTURED
                    </div>
                </div>
            )}

            {isProcessing && (
                <div style={{ padding: '10px', color: '#2563eb', textAlign: 'center', fontWeight: 'bold' }}>
                    Cobel AI Engine: Extracting Technical Terms...
                </div>
            )}

            {assessmentNote && (
                <div style={{ 
                    marginTop: '15px', 
                    padding: '15px', 
                    background: '#f0fdf4', 
                    border: '2px solid #16a34a', 
                    borderRadius: '8px' 
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                        <strong style={{ color: '#166534' }}>Note Attribu√©e:</strong>
                        <span style={{ color: '#16a34a', fontWeight: 'bold', fontSize: '18px' }}>{assessmentNote.grade}</span>
                    </div>
                    <p style={{ fontSize: '12px', color: '#15803d', margin: 0 }}>
                        <strong>Justification:</strong> {assessmentNote.justification}
                    </p>
                </div>
            )}
        </div>
    );
}