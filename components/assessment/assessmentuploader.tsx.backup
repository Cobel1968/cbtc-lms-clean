'use client';
import React, { useState } from 'react';
import { syncHandwritingToEngine } from '@/app/actions/assessment';

export default function AssessmentUploader({ userId }: { userId: string }) {
  const [loading, setLoading] = useState(false);

  const handleUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    setLoading(true);

    const reader = new FileReader();
    
    // Rollback-safe: Handle reader errors to prevent UI hang
    reader.onerror = () => {
      setLoading(false);
      alert("Failed to read the file. Please try again.");
    };

    reader.onload = async () => {
      try {
        const base64 = reader.result as string;
        const result = await syncHandwritingToEngine(userId, base64);
        
        if (result.success) {
          alert(`Sync Complete! New Forecast: ${result.new_forecast}`);
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (err) {
        console.error("Ingestion failed:", err);
      } finally {
        setLoading(false);
      }
    };

    reader.readAsDataURL(file);
  };

  return (
    <div className="p-6 border-2 border-dashed border-blue-400 rounded-xl bg-blue-50 text-center">
      <h3 className="text-lg font-bold text-blue-900 mb-2">Analog-to-Digital Bridge</h3>
      <p className="text-sm text-blue-700 mb-4">Scan your exam or take a photo with your phone</p>
      
      {/* Added 'name' attribute to satisfy browser form field requirements */}
      <input 
        type="file" 
        accept="image/*" 
        capture="environment" 
        onChange={handleUpload}
        className="hidden"
        id="assessment-upload"
        name="assessment_file_input"
        title="Upload vocational assessment for OCR analysis"
      />
      
      <label 
        htmlFor="assessment-upload"
        className={`cursor-pointer px-6 py-2 rounded-lg font-bold transition inline-block ${
          loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'
        }`}
      >
        {loading ? 'Analyzing Handwriting...' : 'Start Ingestion'}
      </label>
    </div>
  );
}