'use client';
import React, { useState, useEffect } from 'react';

export default function AssessmentUploader({ userId }: { userId: string }) {
    const [previewUrl, setPreviewUrl] = useState<string | null>(null);
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [result, setResult] = useState<any>(null);

    // Clean up memory on unmount
    useEffect(() => {
        return () => {
            if (previewUrl) URL.revokeObjectURL(previewUrl);
        };
    }, [previewUrl]);

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        // Reset states for new upload
        setResult(null);
        setIsAnalyzing(true);

        // Generate and set the Preview Image
        const objectUrl = URL.createObjectURL(file);
        setPreviewUrl(objectUrl);

        // Simulate Cobel AI Engine: OCR Pre-processing & Contextual Extraction
        setTimeout(() => {
            setResult({
                score: "88%",
                detectedTerms: ["Atelier", "Équipement", "Maintenance"],
                fluency: "High",
                feedback: "L'analyse montre une excellente maîtrise du vocabulaire technique bilingue."
            });
            setIsAnalyzing(false);
        }, 2500);
    };

    return (
        <div style={{ 
            background: '#ffffff', 
            border: '2px dashed #2563eb', 
            borderRadius: '12px', 
            padding: '20px',
            boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)' 
        }}>
            <h3 style={{ margin: '0 0 10px 0', color: '#1e293b', fontSize: '16px' }}>
                 Analog-to-Digital Bridge
            </h3>
            <p style={{ fontSize: '12px', color: '#64748b', marginBottom: '15px' }}>
                Scan your handwritten vocational assessment.
            </p>

            <input 
                type="file" 
                onChange={handleFileChange} 
                accept="image/*"
                style={{ fontSize: '12px', width: '100%' }}
            />

            {/* THE PREVIEW SECTION */}
            {previewUrl && (
                <div style={{ marginTop: '20px', border: '1px solid #e2e8f0', borderRadius: '8px', padding: '10px', background: '#f8fafc' }}>
                    <p style={{ fontSize: '10px', fontWeight: 'bold', color: '#2563eb', textTransform: 'uppercase' }}>Captured Scan:</p>
                    <img 
                        src={previewUrl} 
                        alt="Handwritten Scan" 
                        style={{ width: '100%', height: 'auto', borderRadius: '4px', display: 'block' }} 
                    />
                </div>
            )}

            {/* THE ANALYSIS SECTION */}
            {isAnalyzing && (
                <div style={{ marginTop: '15px', textAlign: 'center' }}>
                    <div className="spinner" style={{ border: '3px solid #f3f3f3', borderTop: '3px solid #2563eb', borderRadius: '50%', width: '20px', height: '20px', animation: 'spin 1s linear infinite', margin: '0 auto' }}></div>
                    <p style={{ fontSize: '11px', color: '#2563eb', marginTop: '5px' }}>Cobel AI Engine analyzing handwriting...</p>
                </div>
            )}

            {result && (
                <div style={{ 
                    marginTop: '20px', 
                    padding: '15px', 
                    background: '#ecfdf5', 
                    border: '1px solid #10b981', 
                    borderRadius: '8px' 
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <span style={{ fontWeight: 'bold', color: '#065f46' }}>Technical Fluency:</span>
                        <span style={{ color: '#059669', fontWeight: '800' }}>{result.score}</span>
                    </div>
                    <div style={{ fontSize: '12px', color: '#065f46', marginTop: '10px' }}>
                        <strong>Terms Extracted:</strong> {result.detectedTerms.join(', ')}
                    </div>
                    <p style={{ fontSize: '11px', fontStyle: 'italic', color: '#047857', marginTop: '8px', borderTop: '1px solid #a7f3d0', paddingTop: '8px' }}>
                        {result.feedback}
                    </p>
                </div>
            )}

            <style>{`
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            `}</style>
        </div>
    );
}