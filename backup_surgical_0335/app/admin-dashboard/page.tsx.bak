'use client';
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';

export default function AdminDashboard() {
    const [stats, setStats] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        async function fetchStats() {
            const { data } = await supabase.from('user_profiles').select('*, modules(title_en)');
            if (data) setStats(data);
            setLoading(false);
        }
        fetchStats();
    }, []);

    if (loading) return <div className="p-20 text-center">Aggregating Engine Metrics...</div>;

    return (
        <div className="max-w-6xl mx-auto p-10">
            <header className="mb-10 flex justify-between items-end">
                <div>
                    <h1 className="text-3xl font-bold text-slate-900">Trainer Oversight</h1>
                    <p className="text-slate-500">Automated Milestone Forecasting & Fluency Tracking</p>
                </div>
                <div className="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold text-sm">
                    Active Nodes: 191
                </div>
            </header>

            <div className="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
                <table className="w-full text-left">
                    <thead className="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th className="p-4 font-semibold text-slate-700">Module</th>
                            <th className="p-4 font-semibold text-slate-700">Fluency Score</th>
                            <th className="p-4 font-semibold text-slate-700">Predicted Timeframe</th>
                            <th className="p-4 font-semibold text-slate-700">Sync Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        {stats.map((s, i) => (
                            <tr key={i} className="border-b border-slate-100 hover:bg-slate-50">
                                <td className="p-4 font-medium">{s.modules?.title_en || 'General'}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-2">
                                        <div className="w-24 bg-slate-200 h-2 rounded-full overflow-hidden">
                                            <div className="bg-blue-600 h-full" style={{ width: `${s.fluency_score}%` }}></div>
                                        </div>
                                        <span className="text-sm font-bold">{Math.round(s.fluency_score)}%</span>
                                    </div>
                                </td>
                                <td className="p-4 text-slate-600">{s.predicted_timeframe}</td>
                                <td className="p-4">
                                    <span className={`px-2 py-1 rounded text-xs font-bold ${
                                        s.last_sync_type === 'Analog-to-Digital' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'
                                    }`}>
                                        {s.last_sync_type || 'Digital Diagnostic'}
                                    </span>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
}