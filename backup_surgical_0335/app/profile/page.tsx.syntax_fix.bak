'use client';
import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';
import Image from 'next/image';

export default function StudentDashboard() {
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const loadEverything = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;

            const { data: progress } = await supabase
                .from('user_progress')
                .select('*')
                .eq('user_id', user.id)
                .order('updated_at', { ascending: false })
                .limit(1);

            if (progress && progress[0]) {
                const latest = progress[0];
                
                // Logic for Feature 3: Forecasting
                const baseDays = 90;
                const savings = latest.last_score >= 15 ? 15 : 0;
                const compDate = new Date();
                compDate.setDate(compDate.getDate() + (baseDays - savings));

                setData({
                    ...latest,
                    savings,
                    projectedDate: compDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }),
                    progressPercent: Math.round(((baseDays - (baseDays - savings)) / baseDays) * 100)
                });
            }
            setLoading(false);
        };
        loadEverything();
    }, []);

    if (loading) return <div style={{padding:'50px', textAlign:'center'}}>Chargement du moteur Cobel AI...</div>;

    return (
        <div style={{ minHeight: '100vh', background: '#f8fafc', padding: '20px', fontFamily: 'sans-serif' }}>
            {/* HEADER WITH LOGO */}
            <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', maxWidth: '1100px', margin: '0 auto 40px auto' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                    {/* FIXED LOGO PATH - Assumes image is in /public/logo.png */}
                    <img src="/logo.png" alt="Cobel BTC" style={{ height: '50px', width: 'auto' }} onError={(e) => { e.target.src = 'https://via.placeholder.com/150x50?text=COBEL+BTC'; }} />
                </div>
                <div style={{ textAlign: 'right' }}>
                    <h2 style={{ margin: 0, color: '#1e40af', fontSize: '18px' }}>Tableau de Bord Étudiant</h2>
                    <p style={{ margin: 0, fontSize: '12px', color: '#64748b' }}>Innovation: Logiciel de Pédagogie Adaptative</p>
                </div>
            </header>

            <main style={{ maxWidth: '1100px', margin: '0 auto', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '25px' }}>
                
                {/* COLUMN 1: ANALOG BRIDGE & PATH MAPPING */}
                <section style={{ display: 'flex', flexDirection: 'column', gap: '25px' }}>
                    <div style={{ background: '#fff', padding: '25px', borderRadius: '16px', border: '1px solid #e2e8f0' }}>
                        <h3 style={{ marginTop: 0, color: '#1e40af' }}>F4: Pont d'Analyse</h3>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '32px', fontWeight: 'bold' }}>{data?.last_score}/20</span>
                            <span style={{ color: '#16a34a', fontSize: '14px' }}>Confiance OCR: {data?.ocr_accuracy}%</span>
                        </div>
                        <div style={{ marginTop: '15px' }}>
                            <p style={{ fontSize: '12px', fontWeight: 'bold', color: '#64748b' }}>TERMES BILINGUES MAÎTRISÉS:</p>
                            <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap' }}>
                                {data?.technical_terms_mastered?.map(t => (
                                    <span key={t} style={{ background: '#eff6ff', border: '1px solid #bfdbfe', padding: '2px 8px', borderRadius: '4px', fontSize: '11px' }}>{t}</span>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div style={{ background: '#fff', padding: '25px', borderRadius: '16px', border: '1px solid #e2e8f0' }}>
                        <h3 style={{ marginTop: 0, color: '#1e40af' }}>F2: Parcours Adaptatif</h3>
                        <ul style={{ listStyle: 'none', padding: 0 }}>
                            <li style={{ padding: '10px', background: '#dcfce7', borderRadius: '8px', marginBottom: '8px', fontSize: '14px' }}>✅ Advanced Technical Management <strong style={{fontSize:'10px'}}>DÉBLOQUÉ</strong></li>
                            <li style={{ padding: '10px', background: '#f1f5f9', borderRadius: '8px', fontSize: '14px', color: '#94a3b8' }}>⏭️ Basics of Workshop Safety <strong style={{fontSize:'10px'}}>PASSÉ (OPTIMISÉ)</strong></li>
                        </ul>
                    </div>
                </section>

                {/* COLUMN 2: FORECASTING */}
                <section style={{ background: '#0f172a', color: 'white', padding: '40px', borderRadius: '24px', position: 'relative', overflow: 'hidden' }}>
                    <div style={{ position: 'relative', z-index: 2 }}>
                        <h3 style={{ marginTop: 0, color: '#3b82f6' }}>F3: Prévision des Jalons</h3>
                        <p style={{ opacity: 0.7 }}>Optimisation Temporelle Automatisée</p>
                        
                        <div style={{ margin: '40px 0' }}>
                            <div style={{ fontSize: '14px', marginBottom: '10px' }}>Date de Fin Estimée</div>
                            <div style={{ fontSize: '36px', fontWeight: 'bold' }}>{data?.projectedDate}</div>
                        </div>

                        <div style={{ background: '#1e293b', padding: '20px', borderRadius: '12px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                <span>Gain de Temps</span>
                                <span style={{ color: '#10b981' }}>-{data?.savings} Jours</span>
                            </div>
                            <div style={{ width: '100%', height: '8px', background: '#334155', borderRadius: '10px' }}>
                                <div style={{ width: `${data?.progressPercent}%`, height: '100%', background: '#10b981', borderRadius: '10px' }}></div>
                            </div>
                        </div>
                    </div>
                    {/* Decorative Background Element */}
                    <div style={{ position: 'absolute', bottom: '-20px', right: '-20px', width: '150px', height: '150px', background: '#3b82f6', filter: 'blur(80px)', opacity: 0.3 }}></div>
                </section>
            </main>
        </div>
    );
}