'use client';
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';

export default function IntegrityCheckPage() {
    const [report, setReport] = useState({ modules: [], loading: true });

    useEffect(() => {
        async function checkIntegrity() {
            const { data: modules } = await supabase.from('modules').select('*');
            
            const checks = (modules || []).map(m => {
                const questions = m.questions || m.content || m.data || [];
                const firstQ = Array.isArray(questions) && questions.length > 0 ? questions[0] : null;
                
                return {
                    moduleName: m.title_en || m.title_fr || "Untitled Module",
                    qCount: questions.length,
                    // Check for our 3 Innovation Requirements
                    hasBilingual: firstQ ? (!!firstQ.text_fr && !!firstQ.text_en) : false,
                    hasTechTerm: firstQ ? !!firstQ.technical_term : false,
                    hasWeight: firstQ ? (!!firstQ.difficulty || !!firstQ.weight) : false,
                    rawKeys: firstQ ? Object.keys(firstQ).join(', ') : 'No Data'
                };
            });

            setReport({ modules: checks, loading: false });
        }
        checkIntegrity();
    }, []);

    if (report.loading) return <div style={{padding: '50px'}}>Scanning JSON Blueprints...</div>;

    return (
        <div style={{ padding: '40px', fontFamily: 'sans-serif' }}>
            <h1 style={{ color: '#1e40af' }}> Integrity Audit: Questions-in-Modules</h1>
            
            <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: '20px' }}>
                <thead>
                    <tr style={{ background: '#f1f5f9', textAlign: 'left' }}>
                        <th style={{ padding: '10px', border: '1px solid #ddd' }}>Module</th>
                        <th style={{ padding: '10px', border: '1px solid #ddd' }}>Count</th>
                        <th style={{ padding: '10px', border: '1px solid #ddd' }}>Bilingual?</th>
                        <th style={{ padding: '10px', border: '1px solid #ddd' }}>Tech Term?</th>
                        <th style={{ padding: '10px', border: '1px solid #ddd' }}>Keys Found</th>
                    </tr>
                </thead>
                <tbody>
                    {report.modules.map((m, i) => (
                        <tr key={i}>
                            <td style={{ padding: '10px', border: '1px solid #ddd' }}>{m.moduleName}</td>
                            <td style={{ padding: '10px', border: '1px solid #ddd' }}>{m.qCount}</td>
                            <td style={{ padding: '10px', border: '1px solid #ddd' }}>{m.hasBilingual ? '' : ''}</td>
                            <td style={{ padding: '10px', border: '1px solid #ddd' }}>{m.hasTechTerm ? '' : ''}</td>
                            <td style={{ padding: '10px', border: '1px solid #ddd' }}><code>{m.rawKeys}</code></td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
}