'use client';
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';

export default function TableHunterPage() {
    const [tables, setTables] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        async function huntData() {
            // This query lists all user-defined tables and their approximate row counts
            const { data, error } = await supabase.rpc('get_table_counts'); 
            
            // If the RPC doesn't exist yet, we'll try a manual fallback for known LMS names
            const suspects = ['questions', 'assessment_items', 'quiz_questions', 'diagnostic_items', 'content_bank'];
            const results = [];

            for (const name of suspects) {
                const { count } = await supabase.from(name).select('*', { count: 'exact', head: true });
                if (count !== null) results.push({ name, count });
            }
            
            setTables(results);
            setLoading(false);
        }
        huntData();
    }, []);

    if (loading) return <div style={{padding: '50px'}}>Scanning Database Horizons...</div>;

    return (
        <div style={{ padding: '40px', fontFamily: 'sans-serif' }}>
            <h1 style={{ color: '#1e40af' }}> Global Question Hunt</h1>
            <p>Scanning all known tables for the 191 missing questions...</p>
            
            <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: '20px' }}>
                <tr style={{ background: '#f1f5f9' }}>
                    <th style={{ padding: '10px', border: '1px solid #ddd' }}>Table Name</th>
                    <th style={{ padding: '10px', border: '1px solid #ddd' }}>Row Count</th>
                    <th style={{ padding: '10px', border: '1px solid #ddd' }}>Status</th>
                </tr>
                {tables.map(t => (
                    <tr key={t.name}>
                        <td style={{ padding: '10px', border: '1px solid #ddd' }}>{t.name}</td>
                        <td style={{ padding: '10px', border: '1px solid #ddd' }}>{t.count}</td>
                        <td style={{ padding: '10px', border: '1px solid #ddd' }}>
                            {t.count >= 190 ? ' TARGET FOUND' : t.count > 0 ? ' Partial Content' : 'Empty'}
                        </td>
                    </tr>
                ))}
            </table>
            {tables.every(t => t.count === 0) && (
                <div style={{marginTop: '20px', color: 'red'}}>
                     No questions found in common tables. They may be in a custom-named table or truly deleted.
                </div>
            )}
        </div>
    );
}