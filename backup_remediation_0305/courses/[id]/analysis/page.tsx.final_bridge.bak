'use client';
import React, { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import { supabase } from '@/lib/supabaseClient';

export default function OCRVerifyPage() {
    const params = useParams();
    const [user, setUser] = useState<any>(null);
    const [metrics, setMetrics] = useState<any>(null);
    const [syncStatus, setSyncStatus] = useState<'idle' | 'syncing' | 'success' | 'error'>('idle');

    useEffect(() => {
        // Immediate check for session
        const getSession = async () => {
            const { data } = await supabase.auth.getSession();
            setUser(data.session?.user || null);
        };
        getSession();
    }, []);

    const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;
        setMetrics({ score: 18.5, accuracy: 98.7, terms: ["Atelier", "Maintenance"] });
    };

    const runStabilizedSync = async () => {
        if (!user) {
            alert(" Session Required: Please ensure you are logged in to update your Digital Profile.");
            return;
        }
        setSyncStatus('syncing');

        const { error } = await supabase
            .from('user_progress')
            .upsert({ 
                user_id: user.id,
                course_id: params.id || 'testing_general',
                last_score: metrics.score,
                ocr_accuracy: metrics.accuracy,
                technical_terms_mastered: metrics.terms,
                updated_at: new Date().toISOString()
            }, { onConflict: 'user_id, course_id' }); // Uses the unique index we created

        if (error) {
            console.error("Sync Error Detail:", error);
            setSyncStatus('error');
        } else {
            setSyncStatus('success');
        }
    };

    return (
        <div style={{ padding: '40px', maxWidth: '600px', margin: '0 auto', background: '#fff', borderRadius: '12px', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h2 style={{ margin: 0 }}>Step 3: Sync Results</h2>
                <span style={{ fontSize: '12px', color: user ? '#16a34a' : '#ef4444' }}>
                     {user ? `User: ${user.email}` : 'Not Logged In'}
                </span>
            </div>

            <input type="file" onChange={handleFileUpload} accept="image/*" style={{ marginBottom: '20px' }} />

            {metrics && (
                <div style={{ borderTop: '1px solid #eee', paddingTop: '20px' }}>
                    <p>Note Detected: <strong>{metrics.score}/20</strong></p>
                    <button 
                        onClick={runStabilizedSync}
                        disabled={syncStatus === 'syncing'}
                        style={{ 
                            width: '100%', padding: '12px', background: '#2563eb', color: 'white', 
                            border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold' 
                        }}
                    >
                        {syncStatus === 'syncing' ? ' Synchronizing...' : 'Finalize & Update Profile'}
                    </button>
                    {syncStatus === 'success' && <p style={{ color: '#16a34a', marginTop: '10px', textAlign: 'center' }}> Profile Updated Successfully!</p>}
                    {syncStatus === 'error' && <p style={{ color: '#ef4444', marginTop: '10px', textAlign: 'center' }}> Error: Check browser console (F12)</p>}
                </div>
            )}
        </div>
    );
}