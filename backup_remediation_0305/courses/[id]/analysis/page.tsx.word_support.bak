'use client';
import React, { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';

export default function FullAnalysisPage() {
    const params = useParams();
    const router = useRouter();
    const [objectUrl, setObjectUrl] = useState<string | null>(null);
    const [isProcessing, setIsProcessing] = useState(false);
    const [report, setReport] = useState<any>(null);

    // Clean up the memory to prevent memory leaks
    useEffect(() => {
        return () => { if (objectUrl) URL.revokeObjectURL(objectUrl); };
    }, [objectUrl]);

    const handleInversion = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        setIsProcessing(true);
        setReport(null);

        // Generate a native Browser Blob URL
        const url = URL.createObjectURL(file);
        setObjectUrl(url);

        // Simulate Cobel AI Engine Analysis
        setTimeout(() => {
            setReport({
                grade: "19 / 20",
                extracted: ["Atelier", "Maintenance", "Equipement"],
                technical_fluency: "High",
                comment: "Physical technical terms extracted successfully. Grade justified by handwriting clarity."
            });
            setIsProcessing(false);
        }, 1500);
    };

    return (
        <div style={{ padding: '40px', maxWidth: '1400px', margin: '0 auto', fontFamily: 'system-ui' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>
                <button onClick={() => router.back()} style={{ padding: '10px 20px', background: '#f1f5f9', border: '1px solid #cbd5e1', borderRadius: '8px', cursor: 'pointer' }}>
                     Quitter l'Analyse
                </button>
                <h1 style={{ color: '#0f172a', margin: 0 }}>Analyse Technique: Pont Analogique-Numérique</h1>
            </div>

            <div style={{ display: 'flex', gap: '30px' }}>
                {/* LEFT COLUMN: UPLOAD & DATA */}
                <div style={{ flex: '1', display: 'flex', flexDirection: 'column', gap: '20px' }}>
                    <div style={{ background: '#fff', border: '2px solid #2563eb', padding: '25px', borderRadius: '16px', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}>
                        <h2 style={{ marginTop: 0, fontSize: '18px' }}>1. Ingestion de l'Évaluation</h2>
                        <input type="file" onChange={handleInversion} accept="image/*" style={{ width: '100%', padding: '10px', border: '1px solid #e2e8f0', borderRadius: '6px' }} />
                    </div>

                    {report && (
                        <div style={{ background: '#f0fdf4', border: '2px solid #16a34a', padding: '25px', borderRadius: '16px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <h2 style={{ color: '#166534', margin: 0 }}>Note: {report.grade}</h2>
                                <span style={{ background: '#16a34a', color: '#fff', padding: '4px 12px', borderRadius: '20px', fontSize: '12px' }}>VALIDÉ</span>
                            </div>
                            <p style={{ fontSize: '14px', color: '#166534', marginTop: '15px' }}><strong>Preuve Technique:</strong> {report.extracted.join(', ')}</p>
                            <p style={{ fontSize: '13px', fontStyle: 'italic', borderTop: '1px solid #bbf7d0', paddingTop: '10px', marginTop: '10px' }}>{report.comment}</p>
                        </div>
                    )}
                </div>

                {/* RIGHT COLUMN: FORCED VISIBILITY PREVIEW */}
                <div style={{ flex: '2', background: '#0f172a', borderRadius: '16px', padding: '20px', minHeight: '600px', position: 'relative' }}>
                    <div style={{ position: 'absolute', top: '10px', left: '20px', color: '#64748b', fontSize: '11px', fontWeight: 'bold' }}>PREUVE VISUELLE / VISUAL PROOF</div>
                    
                    <div style={{ width: '100%', height: '100%', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
                        {objectUrl ? (
                            <img 
                                src={objectUrl} 
                                alt="Handwritten Assessment" 
                                style={{ maxWidth: '100%', maxHeight: '700px', display: 'block', borderRadius: '4px', border: '5px solid #fff' }} 
                            />
                        ) : (
                            <div style={{ color: '#475569', textAlign: 'center' }}>
                                <div style={{ fontSize: '40px', marginBottom: '10px' }}></div>
                                <p>En attente du scan...</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}