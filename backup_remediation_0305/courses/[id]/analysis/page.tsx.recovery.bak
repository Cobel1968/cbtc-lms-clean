'use client';
import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { supabase } from '@/lib/supabaseClient';

export default function ProfileReviewPage() {
    const router = useRouter();
    const [user, setUser] = useState<any>(null);
    const [profileData, setProfileData] = useState<any>(null);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        fetchProfile();
    }, []);

    const fetchProfile = async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
            setUser(session.user);
            const { data } = await supabase
                .from('user_progress')
                .select('*')
                .eq('user_id', session.user.id)
                .order('updated_at', { ascending: false });
            setProfileData(data);
        }
        setIsLoading(false);
    };

    const handleExit = async () => {
        const confirmExit = confirm("Voulez-vous vraiment quitter le système Cobel ?");
        if (confirmExit) {
            await supabase.auth.signOut();
            router.push('/'); // Redirect to home/login
        }
    };

    if (isLoading) return <div style={{padding: '50px', textAlign: 'center'}}>Chargement du profil...</div>;

    return (
        <div style={{ padding: '40px', maxWidth: '1000px', margin: '0 auto', fontFamily: 'sans-serif' }}>
            {/* HEADER WITH EXIT */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '2px solid #e2e8f0', paddingBottom: '20px', marginBottom: '30px' }}>
                <div>
                    <h1 style={{ color: '#0f172a', margin: 0 }}>Tableau de Bord : {user?.email}</h1>
                    <p style={{ color: '#64748b', fontSize: '14px' }}>Innovation : Logiciel de Pédagogie Adaptative</p>
                </div>
                <button 
                    onClick={handleExit}
                    style={{ background: '#ef4444', color: 'white', border: 'none', padding: '10px 20px', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold' }}
                >
                    Quitter le Système ⎋
                </button>
            </div>

            {/* PROFILE REVIEW SECTION */}
            <div style={{ background: '#fff', borderRadius: '16px', border: '1px solid #e2e8f0', overflow: 'hidden' }}>
                <div style={{ background: '#f8fafc', padding: '15px 25px', borderBottom: '1px solid #e2e8f0' }}>
                    <h2 style={{ fontSize: '18px', margin: 0 }}>Historique des Évaluations (Pont Analogique)</h2>
                </div>
                
                <div style={{ padding: '25px' }}>
                    {profileData && profileData.length > 0 ? (
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ textAlign: 'left', borderBottom: '2px solid #f1f5f9' }}>
                                    <th style={{ padding: '10px' }}>Cours</th>
                                    <th style={{ padding: '10px' }}>Note</th>
                                    <th style={{ padding: '10px' }}>Précision OCR</th>
                                    <th style={{ padding: '10px' }}>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {profileData.map((row: any) => (
                                    <tr key={row.id} style={{ borderBottom: '1px solid #f1f5f9' }}>
                                        <td style={{ padding: '12px' }}>{row.course_id}</td>
                                        <td style={{ padding: '12px', fontWeight: 'bold', color: '#16a34a' }}>{row.last_score}/20</td>
                                        <td style={{ padding: '12px' }}>{row.ocr_accuracy}%</td>
                                        <td style={{ padding: '12px', color: '#64748b', fontSize: '13px' }}>
                                            {new Date(row.updated_at).toLocaleDateString()}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    ) : (
                        <p style={{ textAlign: 'center', color: '#94a3b8' }}>Aucune donnée trouvée. Effectuez un scan pour commencer.</p>
                    )}
                </div>
            </div>

            {/* TEMPORAL OPTIMIZATION NOTICE */}
            <div style={{ marginTop: '30px', padding: '20px', background: '#eff6ff', borderRadius: '12px', border: '1px solid #bfdbfe' }}>
                <p style={{ color: '#1e40af', fontSize: '14px', margin: 0 }}>
                    <strong>Analyse IA :</strong> Votre densité de curriculum a été optimisée en fonction de vos scores techniques bilingues.
                </p>
            </div>
        </div>
    );
}