'use client';
import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter } from 'next/navigation';

export default function PathMappingPage() {
    const [audit, setAudit] = useState(null);
    const [path, setPath] = useState([]);
    const router = useRouter();

    useEffect(() => {
        const calculatePath = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;

            const { data } = await supabase
                .from('user_progress')
                .select('*')
                .eq('user_id', user.id)
                .order('updated_at', { ascending: false })
                .limit(1);

            if (data && data[0]) {
                const latest = data[0];
                setAudit(latest);
                
                // COBEL AI ENGINE: Path Mapping Logic
                // If score > 15, we "compress" the curriculum (Time Optimization)
                if (latest.last_score >= 15) {
                    setPath([
                        { id: 1, name: "Advanced Technical Management", status: "Unlocked", reason: "Excellence en Maintenance" },
                        { id: 2, name: "Bilingual Leadership", status: "Unlocked", reason: "Fluence Technique Validée" },
                        { id: 3, name: "Basics of Workshop Safety", status: "Skipped", reason: "Maîtrise Déjà Prouvée" }
                    ]);
                } else {
                    setPath([
                        { id: 1, name: "Technical Fundamentals", status: "Required" },
                        { id: 2, name: "Workshop Safety Review", status: "Required" }
                    ]);
                }
            }
        };
        calculatePath();
    }, []);

    return (
        <div style={{ padding: '40px', maxWidth: '1000px', margin: '0 auto', fontFamily: 'sans-serif' }}>
            <h1 style={{ color: '#1e40af' }}>Feature 2: Dynamic Path Mapping</h1>
            <p style={{ color: '#64748b' }}>Optimisation temporelle basée sur votre évaluation analogique.</p>

            {audit && (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '30px', marginTop: '30px' }}>
                    {/* INPUT DATA */}
                    <div style={{ background: '#f8fafc', padding: '20px', borderRadius: '12px', border: '1px solid #e2e8f0' }}>
                        <h3>Données Sources (Feature 4)</h3>
                        <p>Score: <strong>{audit.last_score}/20</strong></p>
                        <p>Termes: <strong>{audit.technical_terms_mastered?.join(', ')}</strong></p>
                    </div>

                    {/* DYNAMIC OUTPUT */}
                    <div style={{ background: '#fff', padding: '20px', borderRadius: '12px', border: '2px solid #3b82f6' }}>
                        <h3>Parcours Adaptatif Généré</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                            {path.map(item => (
                                <div key={item.id} style={{ padding: '10px', borderRadius: '8px', background: item.status === 'Skipped' ? '#f1f5f9' : '#dcfce7', border: '1px solid #ddd' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                        <strong>{item.name}</strong>
                                        <span style={{ fontSize: '10px', fontWeight: 'bold' }}>{item.status.toUpperCase()}</span>
                                    </div>
                                    <p style={{ fontSize: '11px', margin: '5px 0 0 0', color: '#64748b' }}>{item.reason}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
            
            <button 
                onClick={() => alert("Simulation de Feature 3: Automated Milestone Forecasting lancée...")}
                style={{ marginTop: '30px', width: '100%', padding: '15px', background: '#0f172a', color: 'white', borderRadius: '8px', cursor: 'pointer' }}
            >
                Générer les Prévisions de Jalons (Feature 3) 
            </button>
        </div>
    );
}